from flask import Flask, request, jsonify
from rapidfuzz import process
from flask_cors import CORS

app = Flask(__name__)
CORS(app)


@app.route("/recommend", methods=["POST"])
def recommend():
    data = request.get_json()
    mainQ = data.get("mainQ", "")
    gender = data.get("gender", "")
    questions = data.get("questions", [])
    userInput = data.get("userInput", "")

    dataFromUserInput = questions + [mainQ, gender] + userInput.split(' ')

    keywordsFromUser = set()
    print("main",mainQ)

    keywords = {
        # ğŸ”¹ Ø§Ù„Ù†ÙˆØ¹ ÙˆØ§Ù„Ø·Ø§Ø¨Ø¹
        "Ø±Ø¬Ø§Ù„ÙŠ", "Ù„Ù„Ø±Ø¬Ø§Ù„", "Ø±Ø¬Ø§Ù„ÙŠÙ‡", "Ø±Ø¬ÙˆÙ„ÙŠ", "Ø­Ø±ÙŠÙ…ÙŠ", "Ù†Ø³Ø§Ø¦ÙŠ", "Ù„Ù„Ù†Ø³Ø§Ø¡", "Ø£Ù†Ø«ÙˆÙŠ", "Ø¨Ù†Ø§ØªÙŠ", "Ø¬Ø°Ø§Ø¨",
        "Ù…Ø«ÙŠØ±", "Ø´ÙŠÙƒ", "Ø±Ø§ÙŠÙ‚", "ÙƒÙ„Ø§Ø³ÙŠÙƒ", "ÙØ®Ù…", "Ø±Ø§Ù‚ÙŠ", "Ù…Ù„ÙƒÙŠ", "Ø¹Ù…Ù„ÙŠ", "Ø´Ø¨Ø§Ø¨ÙŠ", "Ø±ÙˆÙ…Ø§Ù†Ø³ÙŠ", "Ù†Ø¸ÙŠÙ", "Ù†Ø§Ø¹Ù…","ÙˆØ±Ø¯"

        # ğŸ”¹ Ø§Ù„Ù‚ÙˆØ© ÙˆØ§Ù„Ø«Ø¨Ø§Øª
        "Ù‚ÙˆÙŠ", "Ø¬Ø§Ù…Ø¯", "Ø¹Ù†ÙŠÙ", "ÙÙˆØ§Ø­", "Ø«Ø§Ø¨Øª", "Ø¨ÙŠØ«Ø¨Øª", "Ù‡Ø§Ø¯ÙŠ", "Ø®ÙÙŠÙ", "Ù†Ø§Ø¹Ù…", "ØªÙ‚ÙŠÙ„",
        "Ù…Ø´ ÙÙˆØ§Ø­", "Ù…Ø´ Ø«Ø§Ø¨Øª", "Ø±ÙŠØ­ØªÙ‡ Ø¨ØªÙ‡Ø¯Ù‰", "Ø®ÙÙŠÙÙ‡", "ØªÙ‚ÙŠÙ„Ù‡", "Ù…Ø¹ØªØ¯Ù„", "Ù…ØªÙˆØ§Ø²Ù†",

        # ğŸ”¹ Ø§Ù„Ø±Ø§Ø¦Ø­Ø© ÙˆØ§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
        "Ù„ÙŠÙ…ÙˆÙ†", "Ø­Ù…Ø¶ÙŠ", "Ø­Ù…Ø¶ÙŠØ§Øª", "Ù…ÙˆØ§Ù„Ø­", "Ø¨Ø±ØªÙ‚Ø§Ù„", "ÙŠÙˆØ³ÙÙŠ", "ØªÙØ§Ø­", "Ø®ÙˆØ®", "Ø£Ù†Ø§Ù†Ø§Ø³", "Ù…Ø§Ù†Ø¬Ùˆ", "ÙØ±Ø§ÙˆÙ„Ø©",
        "ÙƒØ±ÙŠÙ…ÙŠ", "ÙØ§Ù†ÙŠÙ„ÙŠØ§", "ÙØ§ÙƒÙ‡Ø©", "Ø³ÙƒÙ‘Ø±ÙŠ", "Ø­Ù„Ùˆ", "Ø­Ù„Ø§ÙˆØ©", "Ø²Ù‡Ø±ÙŠ", "ÙˆØ±Ø¯", "ÙÙ„", "ÙŠØ§Ø³Ù…ÙŠÙ†", "Ù„Ø§ÙÙ†Ø¯Ø±",
        "Ù…Ø³Ùƒ", "Ù…Ø³ÙƒÙŠ", "Ø¹Ù†Ø¨Ø±", "Ø¹ÙˆØ¯", "Ø¹ÙˆØ¯ÙŠ", "Ø®Ø´Ø¨", "Ø®Ø´Ø¨ÙŠ", "Ø¬Ù„Ø¯ÙŠ", "Ø¬Ù„Ø¯", "ØªØ¨Øº", "Ù‚Ù‡ÙˆØ©", "ÙƒØ§ÙƒØ§Ùˆ",
        "ØªÙˆØ§Ø¨Ù„", "Ø¨Ù‡Ø§Ø±Ø§Øª", "Ø­Ø§Ø±", "Ø¯Ø§ÙÙŠ", "Ø¨Ø§Ø±Ø¯", "Ù…Ù†Ø¹Ø´", "Ù†Ø¸ÙŠÙ", "ØµØ§Ø¨ÙˆÙ†", "Ù…Ø§Ø¦ÙŠ", "Ø¨Ø­Ø±ÙŠ", "Ù…Ù„Ø­ÙŠ",
        "Ø£Ø®Ø¶Ø±", "Ø¹Ø´Ø¨ÙŠ", "ØªØ±Ø§Ø¨ÙŠ", "Ø²Ù‡ÙˆØ±", "Ø²Ù‡Ø±", "Ø¨Ø§ØªØ´ÙˆÙ„ÙŠ", "Ø·Ø¨ÙŠØ¹ÙŠ", "Ø¨Ù„Ø§Ø³ØªÙŠÙƒ", "Ù…Ø®Ø¯Ø±", "Ù†ÙƒÙ‡ÙŠ",

        # ğŸ”¹ Ø§Ù„ÙˆÙ‚Øª ÙˆØ§Ù„Ù…ÙˆØ³Ù…
        "ØµØ¨Ø§Ø­ÙŠ", "Ù†Ù‡Ø§Ø±ÙŠ", "Ù…Ø³Ø§Ø¦ÙŠ", "Ù„ÙŠÙ„ÙŠ", "ØµÙŠÙÙŠ", "Ø´ØªÙˆÙŠ", "Ø±Ø¨ÙŠØ¹ÙŠ", "Ø®Ø±ÙŠÙÙŠ", "Ø¯Ø§ÙÙŠ", "Ù…Ù†Ø¹Ø´",
        "Ø­Ø±", "Ø¨Ø±Ø¯", "Ø¬Ùˆ Ø¨Ø§Ø±Ø¯", "Ø¬Ùˆ Ø­Ø±", "Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„ØµÙŠÙ", "Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ø´ØªØ§",

        # ğŸ”¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø© ÙˆØ§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…
        "ÙŠÙˆÙ…ÙŠ", "Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙŠÙˆÙ…ÙŠ", "Ø®Ø±ÙˆØ¬", "Ù…Ø´Ø§ÙˆÙŠØ±", "Ø´ØºÙ„", "Ø¯ÙˆØ§Ù…", "Ù…Ù†Ø§Ø³Ø¨Ø§Øª", "Ø­ÙÙ„Ø§Øª", "Ø³Ù‡Ø±Ø§Øª",
        "ÙØ±Ø­", "Ø®Ø±ÙˆØ¬Ø©", "Ø³ÙØ±", "Ø¹Ø·Ø±ÙŠ Ø±Ø³Ù…ÙŠ", "Ø¹Ø·Ø±ÙŠ ÙƒØ§Ø¬ÙˆØ§Ù„", "Ø¹Ø·Ø±ÙŠ ØµØ¨Ø§Ø­ÙŠ", "Ø³Ù‡Ø±Ù‡", "Ù…ÙƒØªØ¨",

        # ğŸ”¹ Ø§Ù„Ø§Ù†Ø·Ø¨Ø§Ø¹ ÙˆØ§Ù„Ø°ÙˆÙ‚
        "Ø¨ÙŠØ¬Ù†Ù†", "ØªØ­ÙØ©", "Ø­Ù„Ùˆ", "Ø¬Ù…ÙŠÙ„", "Ø¹Ø§Ø¯ÙŠ", "Ù…Ø´ Ø­Ù„Ùˆ", "Ù…Ø´ Ù…Ù…ÙŠØ²", "ØºØ±ÙŠØ¨", "ØºØ§Ù…Ø¶",
        "ÙØ§Ø®Ø±", "Ø±Ø§Ù‚ÙŠ", "Ù…Ù…ÙŠØ²", "Ù…Ø¨Ù‡Ø±", "Ù…Ø±ÙŠØ­", "Ù…Ø²Ø¹Ø¬", "Ù†ÙØ³", "Ø¨ÙŠØ®Ù†Ù‚", "Ø®ÙÙŠÙ Ø¹Ø§Ù„Ù‚Ù„Ø¨",
        "ÙŠØ®Ø·Ù", "ÙŠÙ†ÙØ¹ Ù‡Ø¯ÙŠØ©", "Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‡Ø¯Ø§ÙŠØ§",

        # ğŸ”¹ Ø§Ù„Ø¯Ø±Ø¬Ø§Øª ÙˆØ§Ù„Ø±Ø§Ø¦Ø­Ø© Ø§Ù„Ø¹Ø§Ù…Ø©
        "Ø­Ù„ÙˆØ©", "Ù†ÙØ§Ø°", "Ù†Ø§Ø¹Ù…", "Ù‡Ø§Ø¯Ø¦", "Ù‚ÙˆÙŠ", "Ø·Ø§ØºÙŠ", "Ù…ØªÙˆØ³Ø·", "Ù…Ø´ Ù†ÙØ§Ø°", "Ø®ÙÙŠÙ", "ØªØ±ÙƒÙŠØ² Ø¹Ø§Ù„ÙŠ", "ØªØ±ÙƒÙŠØ² Ù…ØªÙˆØ³Ø·",

        # ğŸ”¹ Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø·Ø±
        "Ø¨Ø§Ø±ÙØ§Ù†", "Ø§ÙˆØ¯ÙŠ Ø¨Ø§Ø±ÙØ§Ù†", "Ø§ÙˆØ¯ÙŠ ØªÙˆØ§Ù„ÙŠØª", "ÙƒÙˆÙ„ÙˆÙ†ÙŠØ§", "Ø¹Ø·Ø±", "Ø³Ø¨Ø±Ø§ÙŠ", "Ø²ÙŠØª", "Ù…ÙŠÙ†ÙŠ", "Ø§Ùˆ Ø¯ÙŠ Ø¨ÙŠØ±ÙÙŠÙˆÙ…",
        "Ø§Ùˆ Ø¯ÙŠ ØªÙˆØ§Ù„ÙŠØª",

        # ğŸ”¹ Ù…Ø´Ø§Ø¹Ø± ÙˆØ§Ù†Ø·Ø¨Ø§Ø¹Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
        "Ø¨ÙŠÙÙƒØ±Ù†ÙŠ", "Ø¨ÙŠÙÙƒØ±", "Ø§ÙØªÙƒØ±Øª", "Ø°ÙƒØ±ÙŠØ§Øª", "Ø±ÙŠÙ„Ø§ÙƒØ³", "Ù…Ø±ÙŠØ­ Ù„Ù„Ø£Ø¹ØµØ§Ø¨", "Ù‡Ø§Ø¯ÙŠ Ø§Ù„Ø£Ø¹ØµØ§Ø¨", "Ù…Ø¨Ù‡Ø¬", "Ù…ÙØ±Ø­",
        "Ø¨ÙŠÙ‡Ø¯ÙŠ", "Ø¨ÙŠÙØªØ­ Ø§Ù„Ù†ÙØ³", "ÙŠÙ†ÙˆØ±", "Ù…ÙÙŠØ´ Ø²ÙŠÙ‡", "ÙƒØ¯Ù‡ ÙƒØ¯Ù‡ Ø¬Ø§Ù…Ø¯", "Ø¨ÙŠØ¯ÙÙŠ", "Ø¨ÙŠØ¨Ø±Ø¯", "Ø¨ÙŠÙ…Ù„Ù‰ Ø§Ù„Ù…ÙƒØ§Ù†"
    }
    synonyms = {
        "Ø±Ø¬Ø§Ù„ÙŠ": ["Ø±Ø¬ÙˆÙ„ÙŠ", "Ø°ÙƒÙˆØ±ÙŠ", "Ø±Ø¬Ø§Ù„"],
        "Ø­Ø±ÙŠÙ…ÙŠ": ["Ø£Ù†Ø«ÙˆÙŠ", "Ù†Ø³Ø§Ø¦ÙŠ", "Ø¨Ù†Ø§ØªÙŠ"],
        "Ø²Ù‡Ø±ÙŠ": ["ÙˆØ±Ø¯", "Ø²Ù‡ÙˆØ±", "ÙÙ„", "ÙˆØ±ÙˆØ¯","ÙŠØ§Ø³Ù…ÙŠÙ†"],
        "Ø®Ø´Ø¨ÙŠ": ["Ø¹ÙˆØ¯", "ØµÙ†Ø¯Ù„", "Ø®Ø´Ø¨"],
        "Ø³ÙƒÙ‘Ø±ÙŠ": ["Ø­Ù„Ùˆ", "ÙƒØ±Ø§Ù…ÙŠÙ„", "Ø¹Ø³Ù„ÙŠ", "Ø³ÙˆÙŠØª"],
        "ÙÙˆØ§Ø­": ["Ø«Ø§Ø¨Øª", "Ù…Ù„ÙŠØ§Ù†", "Ù…Ø´Ø¨Ø¹", "ÙŠØ¨ÙŠÙ†"],
        "Ø´ØªÙˆÙŠ": ["Ø¯Ø§ÙØ¦", "Ù…Ø±ÙŠØ­", "Ø­Ø³ÙŠ"],
        "ÙØ§ÙƒÙ‡Ø©": ["ØªÙØ§Ø­", "Ù…Ø§Ù†Ø¬Ø§", "Ø®ÙˆØ®", "Ù…Ø´Ù…Ø´", "Ø£Ù†Ø§Ù†Ø§Ø³"],
        "Ù‚ÙˆÙŠ": ["Ø¬Ø§Ù…Ø¯", "Ø­Ø§Ø¯", "Ù†ÙØ§Ø°"],
        "Ø®ÙÙŠÙ": ["Ù†Ø§Ø¹Ù…", "Ø±Ø§ÙŠÙ‚", "Ø³Ù‡Ù„"]
    }

    match2,score, _ = process.extractOne(mainQ, keywords)
    if score > 70:
        mainQ=match2
    print(mainQ ,"   dddddd")
    for word in dataFromUserInput:
        match, score, _ = process.extractOne(word, keywords)
        if score > 70:
            keywordsFromUser.add(match)

    extractedKeywords = set()
    for word in keywordsFromUser:
        extractedKeywords.add(word)
        for main_word, syns in synonyms.items():
            if word in syns:
                extractedKeywords.add(main_word)

    print(f"keyWords after fuzz {keywordsFromUser}")

    ggg = extractedKeywords
    recommendations = []
    import json

    # 1ï¸âƒ£ Ø§ÙØªØ­ Ø§Ù„Ù…Ù„Ù ÙˆØ§Ù‚Ø±Ø£Ù‡
    file_path = r"perfume_full.json"
    with open(file_path, "r", encoding="utf-8") as f:
        perfume_json = json.load(f)

    # 2ï¸âƒ£ Ø­ÙˆÙ„ Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø¥Ù„Ù‰ set Ø¹Ø´Ø§Ù† Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø§Ø·Ø¹ (&) ØªØ¹Ù…Ù„
    perfume = {k: set(v) for k, v in perfume_json.items()}

    # 4ï¸âƒ£ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆØµÙŠØ§Øª
    for i in perfume:
        score = len(perfume[i] & ggg) / len(ggg)
        if score >= .2 and mainQ in perfume[i] and gender in perfume[i]:
            recommendations.append({"name": i, "score": round(score * 100, 2)})

    if not recommendations:
        for i in perfume:
            score = len(perfume[i] & ggg) / len(ggg)
            if score >= .2 and gender in perfume[i]:
                recommendations.append({"name": i, "score": round(score * 100, 2)})

    if not recommendations:
        return jsonify({"message": "Ø§Ø¹Ø·Ù†ÙŠ ØªÙØ§ØµÙŠÙ„ Ø§ÙƒØªØ±"})

    recommendations.sort(key=lambda x: x["score"], reverse=True)
    print(f"keyWords after fuzz2 {ggg}")
    return jsonify({
        "user_keywords": list(ggg),
        "recommendations": recommendations
    })


if __name__ == "__main__":
    import os
    port = int(os.environ.get("PORT", 5000))
    app.run(host="0.0.0.0", port=port)
